# Update Deployment and Service in Kubernetes

An application deployed on the Kubernetes cluster requires an update with new features developed by the Nautilus application development team. The existing setup includes a deployment named nginx-deployment and a service named nginx-service. Below are the necessary changes to be implemented without deleting the deployment and service:

- 1.) Modify the service nodeport from `30008` to `32165`
- 2.) Change the replicas count from `1` to `5`
- 3.) Update the image from `nginx:1.17` to `nginx:latest`

> Note: The kubectl utility on jump_host is configured to operate with the Kubernetes cluster.

## Steps

1. Lets extract deployments into yaml file:

    ```sh
    kubectl get deployments.apps nginx-deployment -o yaml > nginx-deployment.yml
    ```

2. Let's update replicas and container image:

    ```sh
    vi nginx-deployment.yml
    ```

    - `replicas`: 1 to 5
    - `image`: nginx:1.17 to nginx:latest

3. Update deployment

    ```sh
    kubectl apply -f nginx-deployment.yml
    ```

4. Let's extract service

    ```sh
    kubectl get svc
    kubectl get svc nginx-service -o yaml > svc.yml
    ```

5. Let's change the nodeport

    ```sh
    vi svc.yml
    ```

    - change `nodeport`: 30008 to 32165

    ```YAML
    apiVersion: v1
    kind: Service
    metadata:
    annotations:
        kubectl.kubernetes.io/last-applied-configuration: |
        {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{},"name":"nginx-service","namespace":"default"},"spec":{"ports":[{"nodePort":30008,"port":80,"targetPort":80}],"selector":{"app":"nginx-app"},"type":"NodePort"}}
    creationTimestamp: "2025-09-16T15:47:20Z"
    name: nginx-service
    namespace: default
    resourceVersion: "755"
    uid: 11a1de9f-9881-4be2-afa3-7c9e64c5c33a
    spec:
    clusterIP: 10.96.194.172
    clusterIPs:
    - 10.96.194.172
    externalTrafficPolicy: Cluster
    internalTrafficPolicy: Cluster
    ipFamilies:
    - IPv4
    ipFamilyPolicy: SingleStack
    ports:
    - nodePort: 32165
        port: 80
        protocol: TCP
        targetPort: 80
    selector:
        app: nginx-app
    sessionAffinity: None
    type: NodePort
    status:
    loadBalancer: {}
    ```

6. Update service

    ```sh
    kubectl apply -f svc.yml
    ```

7. Verify

    ```shell
     kubectl get svc
    NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
    kubernetes      ClusterIP   10.96.0.1       <none>        443/TCP        21m
    nginx-service   NodePort    10.96.194.172   <none>        80:32165/TCP   17m
    ```

    > replicas:

    ```$ kubectl get pods
    NAME                                READY   STATUS    RESTARTS   AGE
    nginx-deployment-854ff588b7-fq8c4   1/1     Running   0          9m25s
    nginx-deployment-854ff588b7-k6fhw   1/1     Running   0          9m26s
    nginx-deployment-854ff588b7-mm7x4   1/1     Running   0          9m39s
    nginx-deployment-854ff588b7-rscc2   1/1     Running   0          9m39s
    nginx-deployment-854ff588b7-swrwm   1/1     Running   0          9m39s
    ```
